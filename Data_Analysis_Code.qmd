---
title: "Data_Analysis_Code"
subtitle: Analysis Code and Narrative Descriptions
format: pdf
editor: visual
---

# Goals

## Broad question

What social factors are important in female mate choice?

## Specific question(s)

Do interactions with certain male reproductive tactics increase a female's propensity to spawn at a nest?

What is the relationship between number of sneakers at a nest and the propensity for a female to spawn at that nest?

1\.

2\.

# Tidying code

```{r}
#Install and library important packages
#install.packages('ggplot2')
#install.packages('ggeffects')
#install.packages('RColorBrewer')
#install.packages('here')
#install.packages('MASS')
#install.packages('tidyverse')
#install.packages('janitor')
#install.packages('readxl')
#install.packages('brms')
#install.packages('ProbBayes')
library(ProbBayes)
library(ggeffects)
library(tidyverse)
library(janitor)
library(here)
library(ggplot2)
library(readxl)
library(dplyr)
library(brms)
library(RColorBrewer)
library(tibble)
library(MASS)

behavior_sheet <- read_excel("UW_Nest_Behavioral_Sheets_Cleaned.xlsx")

behavior_sheet_date <- as.Date(behavior_sheet$Date)
behavior_sheet$Date <- behavior_sheet_date
behavior_sheet_sep <- behavior_sheet %>%
  mutate(Year = year(Date)) %>%
  mutate(Month = month(Date)) %>%
  mutate(Day = day(Date)) %>%
  relocate(Year, .after = Date) %>%
  relocate(Month, .after = Year) %>%
  relocate(Day, .after = Month)
head(behavior_sheet_sep)

#Fix SAT submission to NM from chr to num
sat_sub <- as.numeric(behavior_sheet_sep$`SAT submission to NM`) #Creates a vector with the same entries but as numbers
behavior_sheet_sep$`SAT submission to NM` <- sat_sub #put it back into the tibble
#Do the same for SNK Submission to SAT
snk_sub <- as.numeric(behavior_sheet_sep$`SNK submission to SAT`)
behavior_sheet_sep$`SNK submission to SAT` <- snk_sub
#Same for NM aggression to SAT
NM_aggsat <- as.numeric(behavior_sheet_sep$`NM aggression to SAT`)
behavior_sheet_sep$`NM aggression to SAT` <- NM_aggsat

behavior_sheet_cln <- behavior_sheet_sep |>
  #Uses the Janitor package to standardize the names
  clean_names()

#Turn the year variable into a character for ease of comparison later on
year_date <- as.character(behavior_sheet_cln$year) #Creates a vector with years as chr
behavior_sheet_cln$year <- year_date #creates a new variable for ease of graphing later on
```

# Visualization

## Female Spawns as a function of Female Visits

This is just to help us visualize what sort of processes are occurring at the nest.

```{r}
fem.ts.fem.v <- behavior_sheet_cln |>
  ggplot(aes(total_female_visits, total_female_spawning)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot
  geom_smooth(method = 'glm', se = F, method.args = list(family = 'poisson'), aes(color = "Poisson")) + #Plots a Poisson model onto the data
  scale_color_manual(name = 'Model', breaks = "Poisson", values = c('Poisson' = 'darkgreen'), guide = 'legend') +
  theme_classic() + #Sets the plot visuals
  labs(x = 'Female Visits (count)', y = 'Females that spawned (count)', title = "How many females spawned as a function of total Female Visits") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.ts.fem.v
```

## Female Visits/Spawns as a function of Average Number of Sneakers

### Total Female visits as a function of Average Number of sneakers

```{r}
fem.v.avg.snk <- behavior_sheet_cln |>
  ggplot(aes(average_snk, total_female_visits)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot 
  geom_smooth(se = F, color = 'darkgreen') + #Adds a trendline for better visuals
  theme_classic() + #Sets the plot visuals
  labs(x = 'Average Number of Sneakers (count)', y = 'Females that visited (count)', title = "How many females visited the nest as a function of Average Number of Sneakers") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.v.avg.snk
  
```

### Total Females spawned as a function of Average Number of sneakers

```{r}
fem.s.avg.snk <- behavior_sheet_cln |>
  ggplot(aes(average_snk, total_female_spawning)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot 
  geom_smooth(se = F, color = 'darkgreen') + #Adds a trendline for better visuals
  theme_classic() + #Sets the plot visuals
  labs(x = 'Average Number of Sneakers (count)', y = 'Females that spawned (count)', title = "How many females spawned at the nest as a function of Average Number of Sneakers") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.s.avg.snk
```

## Female that spawns as a function of being brought to the nest by the Nesting Male

```{r}
fem.s.bnm <- behavior_sheet_cln |>
  mutate('nm.brought.spawns'= (female_spawning_with_nm_brought_by_nm + female_spawning_with_only_sat_brought_by_nm)) |>
  ggplot(aes(nm.brought.spawns, total_female_spawning)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot 
  geom_smooth(method = 'glm.nb', se = F, color = 'darkgreen') + #Plots a Negative Binomial model onto the data
  theme_classic() + #Sets the plot visuals
  labs(x = 'Spawns when brought by the Nesting Male (count)', y = 'Females that spawned (count)', title = "How many females spawned as a function of being brought by the Nesting Male") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.s.bnm
```

## Female Spawns as a function of being brought to the nest by the Satellite Male

```{r}
fem.s.bsat <- behavior_sheet_cln |>
  mutate('sat.brought.spawns'= (female_spawning_sat_brought + females_spawing_sat_brought_sat_only_spawn)) |>
  ggplot(aes(sat.brought.spawns, total_female_spawning)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot 
  geom_smooth(method = 'glm.nb', se = F, color = 'darkgreen') + #Plots a Negative Binomial model onto the data
  theme_classic() + #Sets the plot visuals
  labs(x = 'Spawns when brought by the Satellite Male (count)', y = 'Females that spawned (count)', title = "How many females spawned as a function of being brought by the Satellite Male") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.s.bsat
```

## Female Spawns as a function of being brought to the nest by the Satellite Male and passed to the Nesting Male

```{r}
fem.s.bsat.pnm <- behavior_sheet_cln |>
  mutate('bsat.pnm.spawns'= (female_spawning_sat_passed_to_nm + female_spawning_sat_passed_to_nm_but_only_sat_spawn)) |>
  ggplot(aes(bsat.pnm.spawns, total_female_spawning)) + #gives ggplot dimensions
  geom_point() + #makes the plot a scatterplot 
 geom_smooth(method = 'glm.nb', se = F, color = 'darkgreen') + #Plots a Negative Binomial model onto the data
  theme_classic() + #Sets the plot visuals
  labs(x = 'Spawns when brought by the Satellite Male but passed (count)', y = 'Females that spawned (count)', title = "How many females spawned as a function of being brought by the Satellite Male but passed off") + #Sets the axis and title labels
  theme(plot.title = element_text(hjust = 0.5)) #Moves title to the middle

fem.s.bsat.pnm
```

# Models

### Generalized Linear Models

### Female visits/spawns as a function of Average Number of Sneakers

Based on our visualizations above, we can assume that a negative binomial distribution will be best for our data. This is because, while a Poisson distribution is based on counts, it has the assumption that the mean = variance. Based on our data, the variance is higher than the mean, thus a negative binomial is a better fit for our data.

```{r}
mean.var.table <- behavior_sheet_cln |>
  mutate(
    'average sneaker mean' = mean(behavior_sheet_cln$average_snk),
    'average sneaker variation' = var(behavior_sheet_cln$average_snk), 
    'female visits mean' = mean(behavior_sheet_cln$total_female_visits),
    'female visits sd' = var(behavior_sheet_cln$total_female_visits),
    'female spawns mean' = mean(behavior_sheet_cln$total_female_spawning),
    'female spawns sd' = var(behavior_sheet_cln$total_female_spawning)) |>
  dplyr::select(last_col(offset = 6-1):last_col()) |>
  pivot_longer(cols = 1:6, names_to = 'Which Value', values_to = 'Number') |>
  unique()

mean.var.table  

```

#### (Josh)Female visits as a function of Average Number of Sneakers

```{r}

```

#### (Josh)Female spawns as a function of Average number of sneakers

```{r}

```

### Female spawns as a function of Her Interaction Pathway to the nest

#### Note:

While our data is based on counts, usually making model distributions poisson or negative binomial, we will be analyzing our data counts as binomial. This is because we are trying to see if the "interaction path", what social interaction the female had as she visited the nest, changes the probability of whether or not the female will spawn at that nest. Thus we can consider the number of female visits as the number of trials, with the probability of spawning for each interaction path being the probability.

#### Normalizing the pathways

By normalizing our pathways to the total number of visits, we are making each variable as a fraction of visits for each pathways, i.e. fraction of females that spawned which were brought by the SAT, fraction of females that spawned which were brought by the SAT and passed to the NM. This allows us to understand the probability of a certain pathway leading to spawning success.

```{r}
sheet.normalized <- behavior_sheet_cln |>
  #Normalize the different pathways by the total number of females that spawned
  mutate(
    #Nesting male brings pathway
    'fspawn.nm.b' = ((female_spawning_with_nm_brought_by_nm + female_spawning_with_only_sat_brought_by_nm)/total_female_visits),
    #Satellite male brings pathway
    'fspawn.sat.b' = ((female_spawning_sat_brought + females_spawing_sat_brought_sat_only_spawn)/total_female_visits),
    #Satellite male passes to Nesting Male pathway
    'fspawn.sat.b.p.nm' = ((female_spawning_sat_passed_to_nm + female_spawning_sat_passed_to_nm_but_only_sat_spawn)/total_female_visits)
  )
  
```

#### Model 1 Just Nesting Male

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.1 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.nm.b),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.1') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.1)
#Gives us the summary of the model
print(fem.spawns.path.mdl.1, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.1)
```

#### Model 2 Just Satellite

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.2 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.sat.b),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.2') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.2)
#Gives us the summary of the model
print(fem.spawns.path.mdl.2, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.2)
```

#### Model 3 Just Satellite pass to Nesting Male

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.3 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.sat.b.p.nm),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.3') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.3)
#Gives us the summary of the model
print(fem.spawns.path.mdl.3, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.3)
```

#### Model 4, Just Nesting Male and Just Satellite

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.4 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.nm.b + fspawn.sat.b),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.4') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.4)
#Gives us the summary of the model
print(fem.spawns.path.mdl.4, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.4)
```

#### Model 5, Just Nesting Male and Just Satellite pass to Nesting Male

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.5 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.nm.b + fspawn.sat.b.p.nm),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.5') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.5)
#Gives us the summary of the model
print(fem.spawns.path.mdl.5, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.5)
```

#### Model 6, Just Satellite and Just Satellite pass to Nesting Male

```{r}
sheet.normalized.rmv <- sheet.normalized |>
  #Removing rows where there were data mistakes
  filter(!(total_female_spawning > total_female_visits))


fem.spawns.path.mdl.6 <- sheet.normalized.rmv |>
  brm(data = sheet.normalized.rmv,
    family = binomial(link = 'logit'), #Tell model what type of distribution
    #Specifying the model
    formula = bf(total_female_spawning | trials(total_female_visits) ~ 1 + fspawn.sat.b + fspawn.sat.b.p.nm),
    prior = c(prior(normal(0, 2), class = Intercept)),
    iter = 2000, warmup = 1000, chains = 4, cores = 4, #Markov chain parameters
      seed = 4, #Determines which random numbers
      file = 'Data Analysis Outputs/fem.spawns.path.mdl.6') #saves it as an output

#Gives a plot of the model's predictions
pp_check(fem.spawns.path.mdl.6)
#Gives us the summary of the model
print(fem.spawns.path.mdl.6, digits = 4)
#Plots the Markov chains
plot(fem.spawns.path.mdl.6)
```

#### Compare the models

```{r}
waic(fem.spawns.path.mdl.1)
waic(fem.spawns.path.mdl.2)
waic(fem.spawns.path.mdl.3)
waic(fem.spawns.path.mdl.4)
waic(fem.spawns.path.mdl.5)
waic(fem.spawns.path.mdl.6)
```

Based on the waic values, model 5 which is our model with the Nesting male bringing females and Satellite passing to Nesting male pathways is the best model given our data. This makes biological sense, the better a Nesting male and Satellite pair are the more likely a nest is going to be efficient, chasing sneakers and bringing females!
